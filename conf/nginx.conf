# WebSocket support for Socket.IO - doit Ãªtre en premier
location __PATH__/socket.io/ {
  proxy_pass http://127.0.0.1:__PORT__/socket.io/;
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_cache_bypass $http_upgrade;
  proxy_buffering off;
}

# Service Worker et ressources PWA
location __PATH__/service-worker.js {
  proxy_pass http://127.0.0.1:__PORT__/service-worker.js;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  add_header Cache-Control "no-cache, no-store, must-revalidate";
  add_header Pragma "no-cache";
  add_header Expires "0";
}

# Manifest et ressources PWA
location __PATH__/manifest.json {
  proxy_pass http://127.0.0.1:__PORT__/manifest.json;
  proxy_set_header Host $host;
  add_header Content-Type "application/json";
}

# Images et assets statiques
location __PATH__/images/ {
  proxy_pass http://127.0.0.1:__PORT__/images/;
  proxy_set_header Host $host;
  expires 1d;
  add_header Cache-Control "public, immutable";
}

location __PATH__/assets/ {
  proxy_pass http://127.0.0.1:__PORT__/assets/;
  proxy_set_header Host $host;
  expires 1d;
  add_header Cache-Control "public, immutable";
}

# Route principale
location __PATH__/ {
  proxy_pass http://127.0.0.1:__PORT__/;
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection 'upgrade';
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_cache_bypass $http_upgrade;
  proxy_buffering off;

  # Include SSOWAT user panel.
  include conf.d/yunohost_panel.conf.inc;
}